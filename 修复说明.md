# JZ8P1521 配置修复说明

## 修复内容

根据 JZ8P1521 数据手册 V1.3，修复了以下两个主要问题：

### 1. TCC 分频配置错误（init_generator.py）

**问题描述：**
- 原代码中 TCC 分频注释错误，显示"预分频比=3"，但实际分频比应该是 1:16
- CONT 寄存器的 Bit2-0 直接对应分频系数，不是简单的索引

**修复内容：**
- 更新了 CONT 寄存器的注释说明
- 添加了正确的分频比对应关系表：
  - 0 = 1:2
  - 1 = 1:4
  - 2 = 1:8
  - 3 = 1:16
  - 4 = 1:32
  - 5 = 1:64
  - 6 = 1:128
  - 7 = 1:256
- 生成代码时现在会显示正确的分频比（如"预分频比=1:16"）

**修改文件：**
- `generators/init_generator.py` - `_generate_tcc_init_code()` 方法

### 2. Sleep 唤醒配置错误（sleep_generator.py）

**问题描述：**
- 原代码中 RD 寄存器（ICIECR）的配置逻辑不完整
- 唤醒后的恢复流程顺序不正确
- 没有正确处理中断标志位的清除

**修复内容：**
- 改进了 RD 寄存器的配置逻辑，只在配置了端口变化唤醒时才设置
- 调整了唤醒后的恢复顺序：
  1. 先重新初始化 TCC 定时器（如果使能）
  2. 清除中断标志位（清除唤醒时产生的中断标志）
  3. 恢复中断使能
  4. 使能全局中断
- 添加了更详细的注释说明唤醒配置的关键步骤

**关键修改点：**
- RD 寄存器配置：`if wakeup_config.get("port_change", False) and rd_value != 0:`
- 唤醒后必须先清除中断标志位，再恢复中断使能
- 确保 IMR 寄存器的 ICIE 位正确设置才能使端口变化中断唤醒生效

**修改文件：**
- `generators/sleep_generator.py` - `_generate_1521()` 方法

## 手册参考

### TCC 定时器配置（第 21-22 页）
- CONT 寄存器（控制寄存器）
  - Bit2-0：预分频比选择（0-7 对应 1:2 到 1:256）
  - Bit4：边沿选择（0=上升沿，1=下降沿）
  - Bit5：时钟源选择（0=内部，1=外部）

### Sleep 唤醒配置（第 24-25 页）
- RD 寄存器（P6 端口中断唤醒使能寄存器/ICIECR）
  - Bit0-7：对应 P60-P67 的唤醒使能
  - 0=禁止，1=使能
- IMR 寄存器（中断使能控制寄存器）
  - Bit1：ICIE（端口变化中断使能）
  - 必须先设置 RD 寄存器，再设置 IMR 中的 ICIE 位才能使端口变化中断唤醒生效

## 验证方法

1. **TCC 分频验证：**
   - 生成代码时检查 CONTW 宏的参数和注释
   - 确保分频比注释显示为 1:2、1:4、1:8 等正确值

2. **Sleep 唤醒验证：**
   - 检查生成的 sleep.c 代码中 RD 寄存器的配置
   - 确保唤醒后的恢复流程顺序正确
   - 验证中断标志位清除和中断使能的顺序

## 影响范围

这些修复只影响 JZ8P1521 芯片的代码生成，不影响 JZ8P2615 等其他芯片。

修复后生成的代码将更加符合 JZ8P1521 数据手册的规范，确保 TCC 定时器和 Sleep 唤醒功能正确工作。

