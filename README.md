# JZ8 系列芯片代码生成工具

类似 STM32 CubeMX 的配置工具，支持多种 JZ8 系列芯片的模块配置和代码生成。

## 项目结构

```
jz8-cubmax/
├── main.py              # 主程序入口
├── control.py           # 控制逻辑和业务处理（配置管理、芯片切换）
├── ui.py                # 用户界面主框架
├── chips/               # 芯片支持模块
│   ├── __init__.py     # 模块导出
│   ├── chip_base.py    # 芯片抽象基类
│   ├── chip_registry.py # 芯片注册表
│   ├── jz8p2615.py     # JZ8P2615 芯片实现
│   ├── jz8p1521.py     # JZ8P1521 芯片实现
│   └── README.md        # 芯片模块说明文档
├── 数据手册/            # 芯片数据手册目录
│   ├── JZ8P2615-V1.3.md
│   └── JZ8P1521-V1.3.md
├── 示例项目/            # 参考示例代码
│   ├── 2615/           # JZ8P2615 示例项目
│   └── 1521/           # JZ8P1521 示例项目
└── README.md            # 本文件
```

### 代码结构分析

**当前架构：**

| 文件/模块 | 行数 | 主要职责 | 状态 |
|---------|------|---------|------|
| main.py | 44 | 程序入口，创建控制器和UI | ? 良好 |
| control.py | 1727 | 配置管理、代码生成、芯片切换、工具函数 | ?? 过大 |
| ui.py | 2255 | GUI框架、代码编辑器、所有配置UI组件 | ?? 过大 |
| chips/chip_base.py | 141 | 芯片抽象基类 | ? 良好 |
| chips/chip_registry.py | 68 | 芯片注册表 | ? 良好 |
| chips/jz8p2615.py | 154 | JZ8P2615芯片实现 | ? 良好 |
| chips/jz8p1521.py | 206 | JZ8P1521芯片实现 | ? 良好 |

**代码规模统计：**
- 总代码行数：约 4500+ 行
- 最大文件：ui.py (2255行)、control.py (1727行)
- 平均文件大小：较大，存在优化空间
- 建议单文件行数：< 500 行

**职责分析：**

1. **control.py 职责过多：**
   - ? 配置数据管理（应保留）
   - ? 芯片切换逻辑（应保留）
   - ?? 代码生成逻辑（应拆分到 generators/）
   - ?? 寄存器计算工具（应拆分到 utils/）
   - ?? 文件读写操作（应拆分到 utils/）

2. **ui.py 职责过多：**
   - ? GUI主框架（应保留）
   - ? 代码编辑器组件（可保留或拆分）
   - ?? 各种配置UI组件（应拆分到 ui_components/）
   - ?? 事件处理逻辑（部分可拆分）

### 结构优化建议

**问题识别：**
1. `control.py` 文件过大，职责过多（配置管理 + 代码生成 + 工具函数）
2. `ui.py` 文件过大，UI组件未模块化
3. 代码生成逻辑分散，难以维护和扩展
4. 缺少工具函数模块，重复代码较多

**建议的优化方案：**

```
jz8-cubmax/
├── main.py
├── control.py           # 配置管理和芯片切换 ? 已重构，使用 generators/ 和 utils/ 模块
├── ui.py                # 用户界面主框架（待重构，UI组件待迁移）
├── generators/          # 代码生成模块 ? 已创建
│   ├── __init__.py
│   ├── base_generator.py    # 代码生成基类 ?
│   ├── init_generator.py     # init.c 生成器 ?
│   ├── main_generator.py     # main.c 生成器 ?
│   ├── isr_generator.py      # isr.c 生成器 ?
│   ├── sleep_generator.py     # sleep.c 生成器 ?
│   ├── adc_generator.py      # ADC.C 生成器 ?
│   └── pwm_generator.py      # pwm.c 生成器 ?
├── ui_components/       # UI组件模块 ? 框架已创建
│   └── __init__.py           # 待逐步迁移UI组件
├── utils/               # 工具函数模块 ? 已创建
│   ├── __init__.py
│   ├── register_calc.py      # 寄存器计算工具 ?
│   ├── file_utils.py         # 文件操作工具 ?
│   └── config_validator.py   # 配置验证工具 ?
└── chips/               # 芯片支持模块（保持不变）
    ├── __init__.py
    ├── chip_base.py
    ├── chip_registry.py
    ├── jz8p2615.py
    └── jz8p1521.py
```

**重构状态：**
- ? **utils/** 模块：已完成，包含寄存器计算、文件操作、配置验证工具
- ? **generators/** 模块：已完成，包含所有代码生成器
- ?? **ui_components/** 模块：框架已创建，UI组件待逐步迁移
- ?? **control.py**：待重构，逐步使用新的 generators/ 和 utils/ 模块
- ?? **ui.py**：待重构，逐步将UI组件迁移到 ui_components/

**优化收益：**
- ? 提高代码可维护性：每个模块职责单一，易于理解和修改
- ? 提高代码可扩展性：新增代码生成器或UI组件更容易
- ? 提高代码可测试性：模块化后便于单元测试
- ? 降低文件复杂度：单个文件行数控制在500行以内
- ? 便于团队协作：不同开发者可以并行开发不同模块

## 功能特性

- ? 基础框架已搭建
- ? 图形化用户界面
- ? 配置数据管理
- ? 数据手册解析（基础）
- ? 示例代码模板加载（基础）
- ? 模块配置界面
- ? 代码生成功能
- ? **代码注释开关** - 可选择生成的代码是否包含注释
- ? **多芯片支持** - 支持多种 JZ8 系列芯片，可轻松扩展新芯片

## 使用方法

### 运行程序

```bash
python main.py
```

### 基本操作

1. **选择芯片**：在工具栏的"芯片"下拉框中选择要使用的芯片型号
2. **配置模块**：在左侧树形视图中选择要配置的模块
3. **设置参数**：在中间配置面板中设置各项参数
4. **预览代码**：右侧代码预览窗口会显示生成的代码
5. **保存配置**：通过"文件"菜单保存配置为JSON文件
6. **生成代码**：通过"生成"菜单或工具栏"生成代码"按钮生成对应的C代码
7. **控制注释**：通过工具栏的"生成注释"复选框控制生成的代码是否包含注释

### 芯片选择

- **切换芯片**：在工具栏的"芯片"下拉框中选择不同的芯片型号
- **注意事项**：
  - 切换芯片会重置所有配置，请先保存当前配置
  - 不同芯片的寄存器结构和功能模块可能不同
  - 确保目标芯片的示例项目和数据手册文件存在

### 代码生成选项

- **生成注释**：勾选此选项后，生成的代码将包含详细的中文注释，包括：
  - 寄存器配置说明
  - 功能模块说明
  - 代码段注释
  - 行内注释
  
  取消勾选后，将生成纯净的代码，不包含任何注释，适合生产环境使用。

## 开发状态

### 已完成 ?
- [x] 项目基础框架
- [x] 主程序入口
- [x] 配置控制器
- [x] 图形化界面框架
- [x] 数据手册解析（基础）
- [x] 示例代码模板加载（基础）

### 已完成 ?
- [x] GPIO详细配置界面
- [x] ADC详细配置界面
- [x] 定时器详细配置界面
- [x] PWM详细配置界面
- [x] 中断详细配置界面
- [x] 系统详细配置界面
- [x] 代码生成引擎
- [x] 代码注释开关功能
- [x] 代码导出功能
- [x] 多芯片支持架构
- [x] 芯片切换功能

### 进行中 ?
- [x] 代码结构优化（拆分大文件，模块化重构）
  - [x] 创建 utils/ 模块（寄存器计算、文件操作、配置验证）
  - [x] 创建 generators/ 模块（所有代码生成器）
  - [x] 创建 ui_components/ 模块框架
  - [x] 重构 control.py 使用新模块 ? 已完成
    - [x] 替换文件操作为 utils.file_utils
    - [x] 替换寄存器计算为 utils.register_calc
    - [x] 替换代码生成为 generators 模块
  - [ ] 重构 ui.py 使用新模块（待完成，可选）

### 计划中 ?
- [ ] 引脚图可视化
- [ ] 配置冲突检测（utils/config_validator.py 已创建框架）
- [ ] 项目模板管理
- [ ] 代码格式化选项
- [ ] 单元测试框架

## 系统要求

- Python 3.7+
- tkinter (通常随Python安装)

## 注意事项

1. 确保对应芯片的数据手册文件存在（例如：`JZ8P2615-V1.3.md`）
2. 确保对应芯片的示例项目目录存在并包含示例代码（例如：`示例项目/`）
3. 首次运行会自动解析数据手册和加载示例代码模板
4. 切换芯片前请先保存当前配置，切换后会重置所有配置

## 支持的芯片

### 当前支持的芯片型号

- **JZ8P2615** (默认)
  - 数据手册：`JZ8P2615-V1.3.md`
  - 示例项目：`示例项目/`
  - 头文件：`JZ8P2615.h`

### 添加新芯片支持

如需添加新芯片支持，请参考 `chips/README.md` 文档。基本步骤：

1. 在 `chips/` 目录创建新芯片实现类（继承 `ChipBase`）
2. 实现所有抽象方法（芯片名称、数据手册路径、默认配置等）
3. 在 `chip_registry.py` 中注册新芯片
4. 确保新芯片的示例项目和数据手册文件存在

详细说明请查看 `chips/README.md`。

## 代码质量

### 当前状态
- ? 功能完整：所有核心功能已实现
- ? 架构清晰：芯片抽象层设计良好
- ?? 文件过大：control.py (1727行)、ui.py (2255行) 需要重构
- ?? 职责混杂：代码生成逻辑与配置管理耦合
- ? 可扩展性：芯片支持架构设计良好

### 改进方向
1. **模块化重构**：将大文件拆分为功能模块
2. **代码生成器模式**：使用策略模式组织代码生成逻辑
3. **UI组件化**：将配置UI组件独立为可复用模块
4. **工具函数提取**：将通用工具函数提取到utils模块
5. **单元测试**：为关键模块添加单元测试

## 版本历史

### v1.2.0 (当前)
- ? 新增多芯片支持架构
  - 创建芯片抽象基类 `ChipBase`，支持扩展新芯片
  - 实现芯片注册表 `ChipRegistry`，统一管理所有芯片
  - 支持在运行时切换不同芯片型号
  - 工具栏添加芯片选择下拉框
  - 窗口标题动态显示当前芯片名称
- ? 改进代码生成
  - 所有硬编码的芯片头文件引用改为动态获取
  - 支持不同芯片使用不同的寄存器结构和配置
- ? 添加芯片模块文档 (`chips/README.md`)
- ? 架构优化，提高可扩展性

### v1.1.0
- ? 新增代码注释开关功能
  - 可在工具栏控制生成的代码是否包含注释
  - 支持所有代码生成模块（init.c, main.c, isr.c, sleep.c, pwm.c, ADC.C等）
  - 注释包括寄存器说明、功能说明、行内注释等
- ? 修复配置选项面板显示不完整的问题
- ? 修复ADC代码注释未正确控制的问题
- ? 更新文档说明

### v1.0.0
- 初始版本
- 基础框架搭建完成
- 图形化界面框架完成
- GPIO、ADC、定时器、PWM、中断等模块配置界面
- 代码生成引擎
- 支持 JZ8P2615 芯片

## 许可证

本项目仅供学习和开发使用。

